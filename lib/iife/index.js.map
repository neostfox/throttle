{"version":3,"file":"index.js","sources":["../../src/utils.ts","../../src/error.ts","../../src/throttle.ts"],"sourcesContent":["/**\n * Check Number  is not finite number\n * @param value number to check\n * @returns is finite number\n */\nconst isFinite = (value: number): boolean => {\n\treturn !Number.isFinite(value);\n};\n/**\n * check Number is positive and more than zero\n * @param value number to check\n * @returns is positive and more than zero number\n */\nconst isPositiveInteger = (value: number): boolean => {\n\treturn value > 0 && value % 1 == 0;\n};\n/**\n * check number ispositive and more than zero and not is finite number\n * @param value number to check\n * @returns number is positive and not is finite number and more than zero\n */\nconst isLegalNumber = (value: number): boolean => {\n\treturn isFinite(value) || isPositiveInteger(value);\n};\nfunction firstKeyOfMap<T1, T2>(map: Map<T1, T2>) {\n\tif (map.size === 0) return false;\n\tfor (const entity of map.entries()) {\n\t\tif (entity[0]) {\n\t\t\treturn entity[0];\n\t\t}\n\t}\n\treturn false;\n}\nexport { isLegalNumber, firstKeyOfMap };\n","/**\n * Throttle Cancelled Error Information\n */\nexport class CancelError extends Error {\n\tconstructor() {\n\t\tsuper(\"Tasks has been cancelled\");\n\t\tthis.name = \"cancelled\";\n\t}\n}\nexport class ThrottleError extends Error {\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = \"throttled error\";\n\t}\n}\n","import type { ThrottleOptions, ThrottleResult } from \"./types\";\nimport { isLegalNumber, firstKeyOfMap } from \"./utils\";\nimport { CancelError, ThrottleError } from \"./error\";\n\nclass Throttle {\n\tprivate taskQueue = new Map<Symbol, Promise<any> | void>();\n\tprivate props: ThrottleOptions = {\n\t\tlimit: 10,\n\t\tinterval: 1000,\n\t};\n\t// all tasks count\n\tprivate total: number = 0;\n\t// fulfilled tasks count\n\tprivate fulfilled: number = 0;\n\t// failed tasks count\n\tprivate rejected: number = 0;\n\t// throttle start time\n\tprivate startTime: number = 0;\n\t// current runing tasks number;\n\tprivate activeCount: number = 1;\n\t// current running tasks start time;\n\tprivate currentTick: number = 0;\n\n\tconstructor(options: Partial<ThrottleOptions>) {\n\t\tthis.props = Object.assign(this.props, options);\n\t\tif (!isLegalNumber(this.props.limit)) {\n\t\t\tthrow TypeError(\n\t\t\t\t\"Throttle limit must be ispositive and more than zero and not is finite number\"\n\t\t\t);\n\t\t}\n\t\tif (!isLegalNumber(this.props.interval)) {\n\t\t\tthrow TypeError(\n\t\t\t\t\"Throttle interval must be ispositive and more than zero and not is finite number\"\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * cancel the throttle\n\t */\n\tcancel() {\n\t\tthis.taskQueue.clear();\n\t\tthis.onCannel(new CancelError());\n\t}\n\t/**\n\t * remove task from throttle queue\n\t */\n\tremove(key: Symbol) {\n\t\tif (this.taskQueue.has(key)) {\n\t\t\tthis.taskQueue.delete(key);\n\t\t\treturn;\n\t\t}\n\t\tthis.onError(new ThrottleError(\"Key not found at throttle queue\"));\n\t}\n\t/**\n\t * push task to throttled queue\n\t */\n\tpush<T>(fn: () => Promise<T> | void) {\n\t\tconst key = Symbol();\n\t\tthis.taskQueue.set(key, fn());\n\t\tthis.total++;\n\t\treturn key;\n\t}\n\t/*\n\t * get next task from throttle queue and return it.\n\t * if key or throttle queue is empty, throttle is done immediately\n\t */\n\tprivate next() {\n\t\tconst key = firstKeyOfMap(this.taskQueue);\n\t\tif (!key) {\n\t\t\treturn;\n\t\t}\n\t\tconst fn = this.taskQueue.get(key);\n\t\tthis.taskQueue.delete(key);\n\t\treturn fn;\n\t}\n\t/**\n\t *if called function is Promise.\n\t * then when status fulfilled run next task\n\t */\n\tprivate runPromise(fn: Promise<any>) {\n\t\tfn.then((res) => {\n\t\t\tthis.fulfilled++;\n\t\t\treturn res;\n\t\t})\n\t\t\t.catch((err) => {\n\t\t\t\tthis.rejected++;\n\t\t\t\tthis.onTaskError(err);\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tthis.runNext();\n\t\t\t\tthis.onChange(this.total, this.activeCount);\n\t\t\t});\n\t}\n\t/**\n\t * throttle all tasks is done immediately\n\t */\n\tprivate allTaskDone() {\n\t\tthis.done({\n\t\t\ttotal: this.total,\n\t\t\ttaskTime: Date.now() - this.startTime,\n\t\t\tfulfilled: this.fulfilled,\n\t\t\trejected: this.rejected,\n\t\t});\n\t}\n\t/**\n\t * transform task to promise for execution more than one task at same time\n\t */\n\tprivate saftFunction(fn: () => any) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\ttry {\n\t\t\t\tresolve(fn());\n\t\t\t} catch (err) {\n\t\t\t\treject(err);\n\t\t\t}\n\t\t});\n\t}\n\t/**\n\t * throttle all tasks is done event\n\t * returns throttle result info\n\t */\n\tdone(res: ThrottleResult) {}\n\n\tprivate nextDelay() {\n\t\tconst now = Date.now();\n\t\tconst { limit, interval } = this.props;\n\t\tif (now - this.currentTick > interval) {\n\t\t\tthis.activeCount = 1;\n\t\t\treturn 0;\n\t\t}\n\t\tif (this.activeCount >= limit) {\n\t\t\tthis.activeCount = 1;\n\t\t\tthis.currentTick += interval;\n\t\t} else {\n\t\t\tthis.activeCount++;\n\t\t}\n\t\treturn this.currentTick - now;\n\t}\n\tprivate execute() {\n\t\tconst fn = this.next();\n\t\tif (!fn) this.allTaskDone();\n\t\telse if (fn instanceof Promise) this.runPromise(fn);\n\t\telse this.runPromise(this.saftFunction(fn));\n\t}\n\t/**\n\t * run next task\n\t */\n\tprivate runNext() {\n\t\tconst timer = this.nextDelay();\n\t\tsetTimeout(() => {\n\t\t\tthis.execute();\n\t\t}, timer);\n\t}\n\t/**\n\t * start throttle queue.\n\t */\n\trun() {\n\t\tthis.onBeforeStart();\n\t\tthis.startTime = Date.now();\n\t\tthis.currentTick = Date.now();\n\t\tthis.runNext();\n\t}\n\t/**\n\t * events before the throttle starts\n\t */\n\tonBeforeStart() {}\n\t/**\n\t * events: when the throttle changed\n\t */\n\tonChange(total: number, current: number) {}\n\n\t/**\n\t * events: when the throttle error\n\t */\n\tonError(error: ThrottleError) {}\n\t/**\n\t * events: when the throttle cancelled\n\t */\n\tonCannel(error: CancelError) {}\n\t/**\n\t * events: when the throttle task error\n\t */\n\tonTaskError(error: ThrottleError) {}\n}\nexport default Throttle;\n"],"names":[],"mappings":"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"}