{"version":3,"file":"index.js","sources":["../../src/utils.ts","../../src/error.ts","../../src/throttle.ts"],"sourcesContent":["/**\n * Check Number  is not finite number\n * @param value number to check\n * @returns is finite number\n */\nconst isFinite = (value: number): boolean => {\n\treturn !Number.isFinite(value);\n};\n/**\n * check Number is positive and more than zero\n * @param value number to check\n * @returns is positive and more than zero number\n */\nconst isPositiveInteger = (value: number): boolean => {\n\treturn value > 0 && value % 1 == 0;\n};\n/**\n * check number ispositive and more than zero and not is finite number\n * @param value number to check\n * @returns number is positive and not is finite number and more than zero\n */\nconst isLegalNumber = (value: number): boolean => {\n\treturn isFinite(value) || isPositiveInteger(value);\n};\nfunction firstKeyOfMap<T1, T2>(map: Map<T1, T2>) {\n\tif (map.size === 0) return false;\n\tfor (const entity of map.entries()) {\n\t\tif (entity[0]) {\n\t\t\treturn entity[0];\n\t\t}\n\t}\n\treturn false;\n}\nexport { isLegalNumber, firstKeyOfMap };\n","/**\n * Throttle Cancelled Error Information\n */\nexport class CancelError extends Error {\n\tconstructor() {\n\t\tsuper(\"Tasks has been cancelled\");\n\t\tthis.name = \"cancelled\";\n\t}\n}\nexport class ThrottleError extends Error {\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = \"throttled error\";\n\t}\n}\n","import type { ThrottleOptions, ThrottleResult } from \"./types\";\nimport { isLegalNumber, firstKeyOfMap } from \"./utils\";\nimport { CancelError, ThrottleError } from \"./error\";\n\nclass Throttle {\n\tprivate taskQueue = new Map<Symbol, Promise<any> | void>();\n\tprivate props: ThrottleOptions = {\n\t\tlimit: 10,\n\t\tinterval: 1000,\n\t};\n\t// all tasks count\n\tprivate total: number = 0;\n\t// fulfilled tasks count\n\tprivate fulfilled: number = 0;\n\t// failed tasks count\n\tprivate rejected: number = 0;\n\t// throttle start time\n\tprivate startTime: number = 0;\n\t// current runing tasks number;\n\tprivate activeCount: number = 1;\n\t// current running tasks start time;\n\tprivate currentTick: number = 0;\n\n\tconstructor(options: Partial<ThrottleOptions>) {\n\t\tthis.props = Object.assign(this.props, options);\n\t\tif (!isLegalNumber(this.props.limit)) {\n\t\t\tthrow TypeError(\n\t\t\t\t\"Throttle limit must be ispositive and more than zero and not is finite number\"\n\t\t\t);\n\t\t}\n\t\tif (!isLegalNumber(this.props.interval)) {\n\t\t\tthrow TypeError(\n\t\t\t\t\"Throttle interval must be ispositive and more than zero and not is finite number\"\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * cancel the throttle\n\t */\n\tcancel() {\n\t\tthis.taskQueue.clear();\n\t\tthis.onCannel(new CancelError());\n\t}\n\t/**\n\t * remove task from throttle queue\n\t */\n\tremove(key: Symbol) {\n\t\tif (this.taskQueue.has(key)) {\n\t\t\tthis.taskQueue.delete(key);\n\t\t\treturn;\n\t\t}\n\t\tthis.onError(new ThrottleError(\"Key not found at throttle queue\"));\n\t}\n\t/**\n\t * push task to throttled queue\n\t */\n\tpush<T>(fn: () => Promise<T> | void) {\n\t\tconst key = Symbol();\n\t\tthis.taskQueue.set(key, fn());\n\t\tthis.total++;\n\t\treturn key;\n\t}\n\t/*\n\t * get next task from throttle queue and return it.\n\t * if key or throttle queue is empty, throttle is done immediately\n\t */\n\tprivate next() {\n\t\tconst key = firstKeyOfMap(this.taskQueue);\n\t\tif (!key) {\n\t\t\treturn;\n\t\t}\n\t\tconst fn = this.taskQueue.get(key);\n\t\tthis.taskQueue.delete(key);\n\t\treturn fn;\n\t}\n\t/**\n\t *if called function is Promise.\n\t * then when status fulfilled run next task\n\t */\n\tprivate runPromise(fn: Promise<any>) {\n\t\tfn.then((res) => {\n\t\t\tthis.fulfilled++;\n\t\t\treturn res;\n\t\t})\n\t\t\t.catch((err) => {\n\t\t\t\tthis.rejected++;\n\t\t\t\tthis.onTaskError(err);\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tthis.runNext();\n\t\t\t\tthis.onChange(this.total, this.activeCount);\n\t\t\t});\n\t}\n\t/**\n\t * throttle all tasks is done immediately\n\t */\n\tprivate allTaskDone() {\n\t\tthis.done({\n\t\t\ttotal: this.total,\n\t\t\ttaskTime: Date.now() - this.startTime,\n\t\t\tfulfilled: this.fulfilled,\n\t\t\trejected: this.rejected,\n\t\t});\n\t}\n\t/**\n\t * transform task to promise for execution more than one task at same time\n\t */\n\tprivate saftFunction(fn: () => any) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\ttry {\n\t\t\t\tresolve(fn());\n\t\t\t} catch (err) {\n\t\t\t\treject(err);\n\t\t\t}\n\t\t});\n\t}\n\t/**\n\t * throttle all tasks is done event\n\t * returns throttle result info\n\t */\n\tdone(res: ThrottleResult) {}\n\n\tprivate nextDelay() {\n\t\tconst now = Date.now();\n\t\tconst { limit, interval } = this.props;\n\t\tif (now - this.currentTick > interval) {\n\t\t\tthis.activeCount = 1;\n\t\t\treturn 0;\n\t\t}\n\t\tif (this.activeCount >= limit) {\n\t\t\tthis.activeCount = 1;\n\t\t\tthis.currentTick += interval;\n\t\t} else {\n\t\t\tthis.activeCount++;\n\t\t}\n\t\treturn this.currentTick - now;\n\t}\n\tprivate execute() {\n\t\tconst fn = this.next();\n\t\tif (!fn) this.allTaskDone();\n\t\telse if (fn instanceof Promise) this.runPromise(fn);\n\t\telse this.runPromise(this.saftFunction(fn));\n\t}\n\t/**\n\t * run next task\n\t */\n\tprivate runNext() {\n\t\tconst timer = this.nextDelay();\n\t\tsetTimeout(() => {\n\t\t\tthis.execute();\n\t\t}, timer);\n\t}\n\t/**\n\t * start throttle queue.\n\t */\n\trun() {\n\t\tthis.onBeforeStart();\n\t\tthis.startTime = Date.now();\n\t\tthis.currentTick = Date.now();\n\t\tthis.runNext();\n\t}\n\t/**\n\t * events before the throttle starts\n\t */\n\tonBeforeStart() {}\n\t/**\n\t * events: when the throttle changed\n\t */\n\tonChange(total: number, current: number) {}\n\n\t/**\n\t * events: when the throttle error\n\t */\n\tonError(error: ThrottleError) {}\n\t/**\n\t * events: when the throttle cancelled\n\t */\n\tonCannel(error: CancelError) {}\n\t/**\n\t * events: when the throttle task error\n\t */\n\tonTaskError(error: ThrottleError) {}\n}\nexport default Throttle;\n"],"names":[],"mappings":"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"}